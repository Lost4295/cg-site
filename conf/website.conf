server {
    listen 80;
    server_name 127.0.0.1;

    root /var/www/html/public;
    index index.php index.html;

    # Logs vers la console Docker
    access_log /dev/stdout;
    error_log  /dev/stderr;

    # Fallback vers index.php (équivalent FallbackResource)
    location / {
        try_files $uri $uri/ /index.php$is_args$args;
    }

    # Let's Encrypt HTTP-01
    location ^~ /.well-known/acme-challenge/ {
        default_type text/plain;
        try_files $uri =404;
    }

    # PHP via PHP-FPM (TCP)
    location ~ \.php$ {
        try_files $uri =404;  # évite d'exécuter des scripts inexistants
        include fastcgi_params;
        fastcgi_pass 127.0.0.1:9000;  # php-fpm (image php:fpm)
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT   $document_root;
        fastcgi_buffers 16 16k;
        fastcgi_buffer_size 32k;
        fastcgi_read_timeout 60s;
    }

    # Protections supplémentaires
    location ~ /\. { deny all; }                       # fichiers cachés .*
    location ~* \.(?:ini|log|env|sql|bak|old)$ { deny all; }  # fichiers sensibles

    # (optionnel) taille d'upload
    # client_max_body_size 32m;
}
